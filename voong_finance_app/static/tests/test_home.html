<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Homepage Tests</title>
    <link rel="stylesheet" href="../../../static/tests/qunit.css">
  </head>

  <body>
    <div id="qunit"></div>
    <div id="qunit-fixture">
      <div id="balance-chart"></div>
      <script src="http://code.jquery.com/jquery.min.js"></script>
      <script src="../../../static/js/d3.js"></script>
      <script src="../js/vf.js"></script>
      <script src="../js/home.js"></script>
      <script src="../js/balance-chart.js"></script>
      <script>
	vf.getBalanceUrl = 'get-balance';
	vf.balanceChartId = 'balance-chart';
      </script>
    </div>

    <script src="../../../static/tests/qunit.js"></script>
    <script src="../../../static/tests/sinon.js"></script>
    <script>

      var xhr, requests;
      QUnit.module("initialisation tests", {
	beforeEach: function(){
	  xhr = sinon.useFakeXMLHttpRequest();
	  requests = [];
	  xhr.onCreate = function(request) { requests.push(request); };
	},
	afterEach: function(){
	  xhr.restore();
	}
      });
      
      QUnit.test("initialise makes an ajax call to get the balance data", function(assert) {
	vf.home.initialise();
	assert.equal(requests.length, 1, 'check ajax request');
	assert.equal(requests[0].method, 'GET', 'check http method');
	assert.equal(requests[0].url, vf.getBalanceUrl, 'check url');
      });

      QUnit.test("On unsuccessful response create balance chart", function(assert) {
	var mock_vf = sinon.mock(vf);
	var exp = mock_vf.expects("createBalanceChart").never()
	var server = sinon.fakeServer.create();
	server.respondWith([403, {}, "unauthorised"]);

	vf.home.initialise();

	assert.equal(exp.verify(), true);
	mock_vf.restore();
      });

      QUnit.test("On successful response create balance chart", function(assert) {
	var mock_vf = sinon.mock(vf);
	var exp = mock_vf.expects("createBalanceChart").once();
	var data = [{ "id": 12, "comment": "Hey there" }]
	var server = sinon.fakeServer.create();
	server.respondWith("GET", vf.getBalanceUrl, [200, { "Content-Type": "application/json" }, JSON.stringify(data)]);

	vf.home.initialise();
	server.respond();
	
	assert.equal(exp.verify(), true);
	mock_vf.restore();
      });

      QUnit.test("Submitting initial balance removes/hides the initial balance div", function(assert) {
	assert.equal(true, false, "TODO");
      });
      
    </script>
  </body>
</html>

      
